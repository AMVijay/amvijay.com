<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>JWT Signature using AWS KMS and Typescript/Javascript</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <meta name="description" content="JWT Signature using AWS KMS and Typescript/Javascript">
    <meta name="author" content="VIJAYaraaghavan Manoharan">
    <link rel='stylesheet' type='text/css' media='screen' href='/blog.css'>

    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="manifest" href="/assets/site.webmanifest">

    <!-- Bootstrap Style -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <!-- Highlighter JS files -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/styles/github.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/highlight.min.js"></script>
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-27752939-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-27752939-2');
    </script>
</head>

<body>
    <header>
        <span>VIJAYaraaghavan Manoharan</span>
    </header>
    <main class="container">
<h1 id="generate-jwt-signature-using-aws-kms-and-ecdsa-cryptographic-algorithm">Generate JWT Signature using AWS KMS and ECDSA cryptographic algorithm</h1>
<p class="blog-lastupdated">Last Updated : 22-Dec-2021</p>
<h2 id="use-case">Use case</h2>
<p>Need generate JWT in Javascript/Typescript. Here, AWS KMS should be used for JWT Signature, and JWT algorithm should be ES256.</p>
<hr>
<h2 id="implementation">Implementation</h2>
<h2 id="techstack">Techstack</h2>
<ul>
<li>Javascript or Typescript</li>
<li>AWS KMS Custom Managed Sign and Verify Key</li>
<li>AWS SDK npm package</li>
<li>base64url npm package</li>
<li>ecdsaFormatter npm package </li>
</ul>
<h3 id="implementation-challenge">Implementation Challenge</h3>
<ul>
<li>As per requirement, JWT algorithm should be ES256. Hence, AWS KMS should be configured to use ECDSA cryptographic algorithm. </li>
<li>Here, the challenge is that AWS KMS signature format is DER encoded ASN.1 format (Details are in <a href="https://docs.aws.amazon.com/kms/latest/APIReference/API_Sign.html#API_Sign_ResponseSyntax">https://docs.aws.amazon.com/kms/latest/APIReference/API_Sign.html#API_Sign_ResponseSyntax</a>). But JWT signature should be in base64url encoded R | S format for ECDSA algorithm.</li>
<li>So need to use custom code to convert the AWS KMS generated Signature from DER encoded ASN.1 format to base64url encoded R | S format.  </li>
</ul>
<p>I am separating the implementation into below steps: </p>
<h3 id="step-1-aws-kms-configuration">Step 1 - AWS KMS configuration</h3>
<p>Create Custom Managed Key in AWS KMS with cryptographic algorithm ECDSA. 
AWS KMS configuration would be: </p>
<p><img src="https://amvijay.com/blog/aws-kms-ecdsa-sign-jwt/aws-kms-sign-ecdsa-configuration.jpg" alt=""></p>
<h3 id="step-2-jwt-creation-using-nodejs">Step 2 - JWT Creation using NodeJS</h3>
<p>Create JWT header value. This should be base64url encoded value.</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// JWT Header Creation - base64url encoded format</span>
<span class="hljs-keyword">const</span> header = {
    <span class="hljs-string">"typ"</span>: <span class="hljs-string">"JWT"</span>,
    <span class="hljs-string">"alg"</span>: <span class="hljs-string">"ES256"</span>,
    <span class="hljs-string">"kid"</span>: keyid
}
<span class="hljs-keyword">const</span> jwtHeader = base64url(JSON.stringify(header));

Create JWT payload value. This should be base64url encoded value.
<span class="hljs-comment">// JWT Payload Creation - base64url encoded format</span>
<span class="hljs-keyword">const</span> payload = {
    <span class="hljs-string">"sub"</span>: <span class="hljs-string">"name"</span>,
    <span class="hljs-string">"status"</span>: <span class="hljs-string">"valid"</span>,
    <span class="hljs-string">"aud"</span>: <span class="hljs-string">"name"</span>
}
<span class="hljs-keyword">const</span> jwtPayload = base64url(JSON.stringify(payload));
</code></pre>
<h3 id="step-3-fetch-aws-signature">Step 3 - Fetch AWS Signature</h3>
<p>Using AWS SDK, invoke AWS KMS sign method and fetch the signature.</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> message = Buffer.<span class="hljs-keyword">from</span>(jwtHeader + <span class="hljs-string">"."</span> + jwtPayload);
<span class="hljs-keyword">let</span> kmsResponse = <span class="hljs-keyword">await</span> kms.sign({
      Message: message,
      KeyId: keyid,
      SigningAlgorithm: <span class="hljs-string">'ECDSA_SHA_256'</span>,
      MessageType: <span class="hljs-string">'RAW'</span>
    }).promise();
</code></pre>
<h3 id="step-4-convert-signature-into-jwt-format">Step 4 - Convert Signature into JWT Format</h3>
<p>By default, The AWS KMS Signature will be in DER encoded ASN.1 format. But JWT Signature should be in base64url encoded R || S format. We can call JWT signature as JOSE format. JOSE stands for JSON Object Signature and Encryption.</p>
<pre><code class="lang-javascript"><span class="hljs-attribute">let ecdsaSignature</span> = ecdsaFormatter.derToJose(kmsResponse.Signature, <span class="hljs-string">'ES256'</span>);
</code></pre>
<hr>
<h2 id="conclusion">Conclusion</h2>
<p>As mentioned in use case, able to generate the JWT with ES256 algorithm using AWS KMS signature.</p>
    </main>
    <footer>
    </footer>
</body>

</html>